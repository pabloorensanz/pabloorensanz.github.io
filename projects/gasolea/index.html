<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<meta name="description" content="Encuentra la gasolinera más barata"/>
		<meta name="author" content="@pabloorensanz"/>
		<meta property='og:title' content="Encuentra la gasolinera más barata | @gasolea"/>
		<meta property='og:image' content="screenshot.jpg"/>
		<meta property='og:description' content="Encuentra la gasolinera más barata"/>
		<meta property='og:url' content="https://pabloorensanz.github.io/projects/gasolea"/>
		<title>Encuentra la gasolinera más barata | @gasolea</title>

		<link rel="shortcut icon" href="files/favicon.ico"/> 

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous"/>
		<link href="gasolea.css" rel="stylesheet" rel="stylesheet"/>
		<link href="https://fonts.googleapis.com/css?family=Raleway:400,500" rel="stylesheet"/>

		<script>
			//GOOGLE ANALYTICS
			//(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-57002704-1', 'auto'); ga('send', 'pageview');
		</script>
	</head>
	<body>
		<header>
			<nav class="navbar navbar-light fixed-top bg-custom">
				<a class="navbar-brand" href="#">
					<img alt="@gasolea" src="files/gasolea.png"/>
					<span>GASOLEA</span> <small style="color: white;">Beta</small>
				</a>
			</nav>
		</header>

		<main role="main">
			<div id="gmap-container" class="container-fluid">
				<div id="gmap">
					<p>Cargando mapa...</p>
				</div>
				<div id="position_control">
					<button title="Tu ubicación" style="">
						<div style=""></div>
					</button>
				</div>
			</div>
			<div id="list-container" class="container-fluid">
				<div id="list" class="list-group">
					<p>
						No hay gasolineras en este área.<br/><a href="#">¿Ampliar área?</a>
					</p>
					<script id="listTemplate" type="x-tmpl-mustache">
					<div id=list-item-{{id}} data-id="{{id}}" class="list-group-item list-group-item-action flex-column align-items-start{{#active}} active{{/active}}" itemscope itemtype="https://schema.org/GasStation">
						<div class="">
							<div>
								<img src="files/marker{{rank}}.png" alt="" width="18" height="24"> <b>{{name}}</b>
							</div>
							<small>{{address}}</small><!--<a href="https://maps.google.com/maps?z=12&t=m&q=loc:{{lat}}+{{lng}}" target="_blank" title="Cómo llegar"><small>Cómo llegar</small></a>!-->
							{{#distance}}<small>Distancia {{distance}} Km</small>{{/distance}}
						</div>
						<div class="float-right">
							{{#products.Gasolina 95 Protección}}
							<div>
								<img src="files/g95.png" alt="Gasolina 95" title="Gasolina 95" width="15" height="15"/>
								<small><b>{{products.Gasolina 95 Protección.price}}</b></small>
							</div>
							{{/products.Gasolina 95 Protección}}
							{{#products.Gasolina  98}}
							<div>
								<img src="files/g98.png" alt="Gasolina 98" title="Gasolina 98" width="15" height="15"/>
								<small><b>{{products.Gasolina  98.price}}</b></small>
							</div>
							{{/products.Gasolina  98}}
							{{#products.Gasoleo A}}
							<div>
								<img src="files/goa.png" alt="Gasóleo A" title="Gasóleo A" width="15" height="15"/>
								<small><b>{{products.Gasoleo A.price}}</b></small>
							</div>
							{{/products.Gasoleo A}}
							{{#products.Biodiesel}}
							<div>
								<img src="files/bio.png" alt="Biodiésel" title="Biodiésel" width="15" height="15"/>
								<small><b>{{products.Biodiesel.price}}</b></small>
							</div>
							{{/products.Biodiesel}}
						</div>
						<div>
						</div>
					</div>
					</script>
				</div>
			</div>			
		</main>

		<!-- FOOTER !-->
		<div id="footer" class="fixed-bottom container-fluid">
			
		</div>

		<!-- MODAL !-->
		<div id="geolocation" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Activar ubicación</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<p>Para poder encontrar donde estás, hace falta que autorices a tu navegador a acceder a tu ubicación.</p>
						<p>Siempre que quieras puedes desactivar esta funcionalidad, para este sitio y para cualquier otro.</p>
						<ul>
							<li><a href="https://support.google.com/chrome/answer/142065?hl=es" target="_blank" title="Activar acceso a tu ubicación en Chrome">Activar acceso a tu ubicación en Chrome.</a></li>
							<li><a href="https://www.mozilla.org/es-ES/firefox/geolocation/" target="_blank" title="Activar acceso a tu ubicación en Firefox">Activar acceso a tu ubicación en Firefox.</a></li>
							<li><a href="https://windows.microsoft.com/es-es/internet-explorer/ie-security-privacy-settings#ie=ie-11" target="_blank" title="Activar acceso a tu ubicación en Explorer">Activar acceso a tu ubicación en Internet Exlorer.</a></li>
						</ul>
					</div>
					<div class="modal-footer">

					</div>
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQExA4PyYQ6kXS056nQkL4HrR1tr9pYLg&libraries=places" type="text/javascript"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js" type="text/javascript"></script>
		<script src="gasolea.js" type="text/javascript"></script>
		<script type="text/javascript">
			$(document).ready(function() {
				var position = null,
					data = $.getJSON('https://pabloorensanz.000webhostapp.com/projects/gasolea/data.json'),
					markers = [],
					active = null,
					gmap = $('#gmap').gmap().set({
						change: function () {
							load();
						},
						clicked: function (response) {
							lalala(response);
							return false;
						}
					});
				
				//LOADING
				data.fail(function(response) {
						alert('No se ha podido descargar la información. Vuelve a intentarlo pasados unos minuntos, porfa.');//completar callback
					});

				$.when(geolocation().get())
					.then(function(response) {
						position = response;
						gmap.set({center: position});
					})
					.fail(function(response) {
						gmap.set({center: {lat: 40.4504, lng: -3.7240}});
					})
					.always(function(response) {
						data.done(function () {
							gmap.render().done(function () {
								$('#position_control').show();
								load();
								if(position) {
									gmap.markit({
										lat: position.lat,
										lng: position.lng,
										title: 'me!',
										image: {
											url: 'files/me.png',
											size: new google.maps.Size(30, 42),
											origin: new google.maps.Point(0,0),
											anchor: new google.maps.Point(0, 42)
										}
									});
								}
							})
						});
					});
				
				//POSITION CONTROL
				$('#position_control').on('click', function () {
					$.when(geolocation().get())
						.then(function(response) {
							position = response;
							gmap.pan(position);
							load();
							return false;
						})
						.fail(function(response) {
							$('#geolocation').modal();
						})
				});
				//LIST-GROUP-ITEM CLICKED
				$('#list').on('click', '.list-group-item', function () {
					lalala($(this));
					return false;
				});
				//EXTEND AREA
				$('#list > p').on('click', function () {
					gmap.zoomOut();
					return false;
				});
									
				function load () {
					var viewport = gmap.viewport(),
						stations = data.responseJSON.stations;
					if(stations) {
						gmap.clear();
						for(var i = 0; i < stations.length; i++) {
							if((stations[i].lng >= viewport[3] && stations[i].lng <= viewport[1]) && (stations[i].lat >= viewport[2] && stations[i].lat <= viewport[0])) {
								stations[i].title = stations[i].name;
								if(position) stations[i].distance = Math.round(distance(position.lat, position.lng, stations[i].lat, stations[i].lng) * 10) / 10;
								stations[i].image = {
									url: 'files/marker'+stations[i].rank+'.png',
									size: new google.maps.Size(27, 37),
									origin: new google.maps.Point(0,0),
									anchor: new google.maps.Point(0, 37)
								}
								stations[i].active = false;
								var marker = gmap.markit(stations[i]);
								if(stations[i].id == active) {
									stations[i].active = true;
									gmap.animate(marker);
								}
							}
						}
						$('#list .list-group-item').fadeOut(function () {
							$(this).remove();
						});
						if(gmap.markers.length) {
							$('#list > p').fadeOut();
							gmap.markers.sort(compare);
							for(var key in gmap.markers) {
								$('#list').append(Mustache.render($('#listTemplate').html(), gmap.markers[key].metadata));
							}
						} else {
							$('#list > p').fadeIn();
						}
					} else {
						alert('No se ha podido descargar la información. Vuelve a intentarlo pasados unos minuntos, porfa.');//completar callback
					}
				}
				function lalala (object) {
					if(object instanceof jQuery) {
						//LIST ITEM CLICKED
						active = object.data('id');
						marker = markerWithID(active);
						list_item = object;
						gmap.pan({lat: marker.metadata.lat, lng: marker.metadata.lng});
					} else {
						//MARKER CLICKED
						active = object.metadata.id;
						marker = object;
						list_item = $('#list-item-'+active);
					}
					gmap.animate(marker);
					$('#list .list-group-item').removeClass('active');
					list_item.addClass('active');
					window.location.hash = 'list-item-'+active;
					return false;
				}
				function markerWithID (id) {
					for(i = 0; i < gmap.markers.length; i++) {
						if(gmap.markers[i].metadata.id == id) {
							return gmap.markers[i];
						}
					}
				}
				function compare(a,b) {
					if(a.metadata.rank < b.metadata.rank) return -1;
					if(a.metadata.rank > b.metadata.rank) return 1;
					return 0;
				}
				
				function distance(lat1, lng1, lat2, lng2) {
					var R = 6371; //Radius of the earth in km
					var dlat = (lat2-lat1) * (Math.PI/180);
					var dlng = (lng2-lng1) * (Math.PI/180); 
					var a = Math.sin(dlat/2) * Math.sin(dlat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dlng/2) * Math.sin(dlng/2); 
					var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
					var d = R * c; // Distance in km
					return d;
				}
			})
		</script>
	</body>
</html>